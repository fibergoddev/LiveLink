<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiveLink | Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            base: '#050505',
                            surface: '#0f0f0f',
                            surface2: '#181818',
                            primary: '#00ff9f',
                            primaryDim: 'rgba(0, 255, 159, 0.15)',
                            accent: '#00ccff',
                            danger: '#ff2a6d',
                            warning: '#ffb302',
                            text: '#e0e0e0',
                            muted: '#757575'
                        }
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif']
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .glass {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .typing-dot {
            width: 4px; height: 4px;
            background-color: currentColor; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Smooth inputs on mobile */
        input, textarea, button { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-cyber-base text-cyber-text font-sans h-[100dvh] flex flex-col overflow-hidden selection:bg-cyber-primary selection:text-black">

    <!-- Top Navigation -->
    <nav class="h-16 border-b border-white/5 bg-cyber-surface flex items-center justify-between px-4 z-40 shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-cyber-muted hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="18" y2="18"/></svg>
            </button>
            <div class="flex items-center gap-2">
                <div class="relative w-2.5 h-2.5">
                    <div id="status-dot" class="absolute inset-0 rounded-full bg-cyber-danger shadow-[0_0_8px_rgba(255,42,109,0.5)] transition-colors duration-500"></div>
                    <div id="status-ping" class="absolute inset-0 rounded-full bg-cyber-danger animate-ping hidden"></div>
                </div>
                <h1 class="font-bold tracking-tight text-lg">LIVE<span class="text-cyber-primary">LINK</span> <span class="text-[10px] bg-white/5 px-1.5 py-0.5 rounded text-cyber-muted font-mono align-middle ml-1">ULTRA</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <button onclick="toggleSettings()" class="p-2 text-cyber-muted hover:text-cyber-primary transition-colors" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <div class="hidden md:flex flex-col items-end leading-none">
                <span class="text-[10px] text-cyber-muted uppercase tracking-wider">My ID</span>
                <span id="nav-my-id" class="font-mono text-cyber-accent font-bold text-sm max-w-[150px] truncate">---</span>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute inset-y-0 left-0 w-[85%] max-w-[320px] lg:static lg:w-80 bg-cyber-surface border-r border-white/5 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-30 flex flex-col shadow-2xl lg:shadow-none">
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <!-- Identity Card -->
                <div class="bg-cyber-surface2 p-4 rounded-xl border border-white/5 relative group">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs text-cyber-muted uppercase tracking-widest font-bold">My Identity</span>
                        <div class="flex gap-2">
                             <button onclick="editIdentity()" class="text-cyber-muted hover:text-white" title="Edit ID">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button onclick="copyId()" class="text-cyber-muted hover:text-cyber-primary" title="Copy">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- View Mode -->
                    <div id="id-view-mode">
                        <div class="font-mono text-xl font-bold text-cyber-accent break-all leading-tight" id="sidebar-my-id">...</div>
                        <div class="text-[10px] text-cyber-muted mt-2">Display Name: <span id="sidebar-my-name" class="text-white font-medium">Anonymous</span></div>
                    </div>

                    <!-- Edit Mode -->
                    <div id="id-edit-mode" class="hidden mt-2 space-y-3">
                        <div>
                            <label class="text-[10px] text-cyber-muted uppercase">Custom ID (Unique)</label>
                            <div class="flex relative">
                                <input type="text" id="custom-id-input" class="w-full bg-black border border-white/10 rounded px-2 py-1.5 text-sm text-white focus:border-cyber-primary focus:outline-none" placeholder="john-doe">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-cyber-muted uppercase">Display Name</label>
                            <input type="text" id="custom-name-input" class="w-full bg-black border border-white/10 rounded px-2 py-1.5 text-sm text-white focus:border-cyber-primary focus:outline-none" placeholder="John">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveIdentity()" class="flex-1 bg-cyber-primary text-black text-xs font-bold py-1.5 rounded">SAVE & RELOAD</button>
                            <button onclick="cancelEditIdentity()" class="px-3 bg-white/10 text-white text-xs font-bold py-1.5 rounded">CANCEL</button>
                        </div>
                        <p class="text-[10px] text-red-400 leading-tight">Warning: Saving changes your ID and disconnects current chats.</p>
                    </div>
                </div>

                <!-- Connect Card -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-cyber-muted uppercase tracking-widest">Establish Link</label>
                    <div class="bg-cyber-surface2 p-4 rounded-xl border border-white/5 space-y-3">
                        <p class="text-xs text-cyber-muted">Connect by entering a user's unique ID or Username.</p>
                        <div class="relative">
                            <input type="text" id="partner-id-input" placeholder="Enter User ID / Alias" 
                                class="w-full bg-black/50 border border-white/10 text-center font-mono text-lg py-3 rounded-lg focus:outline-none focus:border-cyber-primary focus:ring-1 focus:ring-cyber-primary/50 transition-all text-white placeholder-white/20">
                        </div>
                        <button id="connect-btn" onclick="initiateConnection()" 
                            class="w-full py-3 bg-cyber-primary text-black font-bold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-400 transition-all flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(0,255,159,0.2)]">
                            <span>SEND REQUEST</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Session Control -->
                <div id="active-session-card" class="hidden animate-slide-up">
                    <div class="bg-cyber-primaryDim border border-cyber-primary/30 p-4 rounded-xl">
                         <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-cyber-primary animate-pulse"></div>
                                <span class="font-bold text-white text-sm">Linked</span>
                            </div>
                            <span class="text-[10px] text-cyber-primary border border-cyber-primary/30 px-1.5 rounded">SECURE</span>
                        </div>
                        <div class="text-sm text-white font-medium mb-1 truncate" id="session-partner-name">...</div>
                        <div class="text-xs text-cyber-muted font-mono mb-3 truncate" id="session-partner-id">ID: ...</div>
                        <button onclick="disconnect()" class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/30 rounded text-xs font-bold transition-colors">
                            TERMINATE
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-white/5 text-center bg-black/20">
                <p class="text-[10px] text-cyber-muted">End-to-End Encrypted â€¢ P2P</p>
            </div>
        </aside>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="lg:hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-20 hidden transition-opacity opacity-0"></div>

        <!-- Chat Main Area -->
        <div class="flex-1 flex flex-col bg-cyber-base relative w-full">
            
            <!-- Chat Header -->
            <div id="chat-header" class="absolute top-0 left-0 right-0 h-14 bg-cyber-surface/95 backdrop-blur border-b border-white/5 flex items-center justify-between px-4 lg:px-6 z-20 transform -translate-y-full transition-transform duration-300">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-cyber-surface2 to-gray-800 border border-white/10 flex items-center justify-center font-bold text-cyber-primary" id="header-avatar">?</div>
                    <div class="flex flex-col justify-center h-full">
                        <span id="header-name" class="font-bold text-sm text-white leading-none mb-1">Unknown</span>
                        <span id="header-status" class="text-[10px] text-cyber-primary font-mono leading-none">CONNECTED</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearChat()" class="p-2 text-cyber-muted hover:text-white" title="Clear Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                </div>
            </div>

            <!-- Empty / Welcome State -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center z-10 pointer-events-none">
                <div class="w-24 h-24 rounded-full bg-cyber-surface border border-white/5 flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                    <svg class="text-cyber-muted opacity-50" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 tracking-tight">Ready to Connect</h3>
                <p class="text-cyber-muted text-sm max-w-xs mx-auto leading-relaxed">Your secure channel is active. Share your ID or Alias to start a private session.</p>
            </div>

            <!-- Messages Container -->
            <div id="messages-area" class="flex-1 overflow-y-auto overflow-x-hidden p-4 lg:p-6 space-y-4 pt-16 pb-2 transition-all">
                <!-- Messages go here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="absolute bottom-20 left-6 flex items-center gap-2 px-3 py-1.5 bg-cyber-surface border border-white/5 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-20">
                <div class="flex gap-1 text-cyber-primary">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
                <span class="text-[10px] text-cyber-muted font-mono" id="typing-text">Partner is typing...</span>
            </div>

            <!-- Input Area -->
            <div class="p-3 lg:p-4 bg-cyber-surface border-t border-white/5 shrink-0 z-30">
                <div class="max-w-4xl mx-auto flex gap-2 lg:gap-4 relative">
                    <!-- Lock Overlay -->
                    <div id="input-lock" class="absolute inset-0 bg-cyber-surface/90 backdrop-blur-[1px] z-10 flex items-center justify-center rounded-lg border border-white/5 cursor-not-allowed">
                        <span class="text-xs font-mono text-cyber-muted uppercase flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            Connection Required
                        </span>
                    </div>

                    <textarea id="chat-input" rows="1" placeholder="Type a secure message..." 
                        class="flex-1 bg-black/40 text-white border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-cyber-primary/50 focus:bg-black/60 transition-all resize-none max-h-32 text-sm lg:text-base leading-relaxed"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; handleTyping()"></textarea>
                    
                    <button onclick="sendMessage()" class="bg-cyber-primary hover:bg-green-400 text-black p-3 rounded-xl transition-transform active:scale-95 flex items-center justify-center aspect-square h-[46px] w-[46px] lg:h-[50px] lg:w-[50px]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-cyber-surface2 border border-white/10 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-scale-in">
            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-black/20">
                <h2 class="font-bold text-white">System Settings</h2>
                <button onclick="toggleSettings()" class="text-cyber-muted hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Toggle Item -->
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-white">Sound Effects</div>
                        <div class="text-xs text-cyber-muted">Play sounds for messages</div>
                    </div>
                    <button id="btn-sound" onclick="app.settings.sound = !app.settings.sound; updateSettingsUI()" class="w-10 h-5 bg-cyber-primary rounded-full relative transition-colors duration-300">
                        <div class="absolute right-1 top-1 w-3 h-3 bg-black rounded-full transition-transform"></div>
                    </button>
                </div>
                <!-- Toggle Item -->
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-white">Do Not Disturb</div>
                        <div class="text-xs text-cyber-muted">Auto-reject requests</div>
                    </div>
                    <button id="btn-dnd" onclick="app.settings.dnd = !app.settings.dnd; updateSettingsUI()" class="w-10 h-5 bg-gray-700 rounded-full relative transition-colors duration-300">
                        <div class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>
                <!-- Toggle Item -->
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium text-white">Auto-Accept</div>
                        <div class="text-xs text-cyber-muted">Accept all incoming requests</div>
                    </div>
                    <button id="btn-auto" onclick="app.settings.autoAccept = !app.settings.autoAccept; updateSettingsUI()" class="w-10 h-5 bg-gray-700 rounded-full relative transition-colors duration-300">
                        <div class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>
                
                <div class="border-t border-white/5 pt-4">
                    <label class="text-xs text-cyber-muted uppercase font-bold mb-2 block">Font Size</label>
                    <input type="range" min="12" max="20" value="14" class="w-full accent-cyber-primary h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.documentElement.style.fontSize = this.value + 'px'">
                    <div class="flex justify-between text-[10px] text-cyber-muted mt-1"><span>Small</span><span>Large</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Connection Request -->
    <div id="request-modal" class="fixed inset-0 modal-backdrop z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-cyber-surface border border-cyber-primary/50 w-full max-w-sm rounded-2xl shadow-[0_0_50px_rgba(0,255,159,0.1)] overflow-hidden animate-scale-in">
            <div class="p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-cyber-surface2 border border-cyber-primary mx-auto flex items-center justify-center mb-4 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyber-primary opacity-20"></span>
                    <svg class="text-cyber-primary relative z-10" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-1">Incoming Link</h3>
                <p class="text-cyber-muted text-sm mb-6"><span id="req-name" class="text-white font-bold">Unknown</span> wants to connect.</p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="handleRequestDecision(false)" class="py-3 bg-white/5 hover:bg-red-500/20 text-white hover:text-red-400 border border-white/10 hover:border-red-500/50 rounded-lg font-bold text-sm transition-all">DECLINE</button>
                    <button onclick="handleRequestDecision(true)" class="py-3 bg-cyber-primary hover:bg-green-400 text-black rounded-lg font-bold text-sm transition-all shadow-lg shadow-cyber-primary/20">ACCEPT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-cyber-surface2 border border-white/10 text-white px-5 py-3 rounded-lg shadow-2xl -translate-y-32 transition-transform duration-300 z-[70] flex items-center gap-3 min-w-[320px]">
        <div id="toast-icon" class="text-cyber-primary shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>
        <p id="toast-msg" class="text-sm font-medium">Notification</p>
    </div>

    <script>
        // --- Core State ---
        const app = {
            peer: null,
            conn: null,
            myId: null,
            myName: localStorage.getItem('livelink_name') || 'Anonymous',
            pendingConn: null, // Stores connection waiting for approval
            settings: {
                sound: true,
                dnd: false,
                autoAccept: false
            },
            reconnectTimer: null
        };

        // --- Audio System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!app.settings.sound || audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => {});
                if (!app.settings.sound) return;
            }
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'msg') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(400, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'req') {
                osc.type = 'triangle';
                // Double beep
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2); gain2.connect(audioCtx.destination);
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(600, now + 0.15);
                gain2.gain.setValueAtTime(0.1, now + 0.15);
                gain2.gain.linearRampToValueAtTime(0, now + 0.25);
                
                osc.start(now); osc.stop(now + 0.1);
                osc2.start(now + 0.15); osc2.stop(now + 0.25);
            }
        }

        // --- UI References ---
        const ui = {
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay'),
            statusDot: document.getElementById('status-dot'),
            statusPing: document.getElementById('status-ping'),
            idDisplay: document.getElementById('sidebar-my-id'),
            nameDisplay: document.getElementById('sidebar-my-name'),
            navId: document.getElementById('nav-my-id'),
            idView: document.getElementById('id-view-mode'),
            idEdit: document.getElementById('id-edit-mode'),
            customIdInput: document.getElementById('custom-id-input'),
            customNameInput: document.getElementById('custom-name-input'),
            partnerInput: document.getElementById('partner-id-input'),
            connectBtn: document.getElementById('connect-btn'),
            messages: document.getElementById('messages-area'),
            input: document.getElementById('chat-input'),
            typing: document.getElementById('typing-indicator'),
            modals: {
                settings: document.getElementById('settings-modal'),
                request: document.getElementById('request-modal')
            },
            reqName: document.getElementById('req-name'),
            header: document.getElementById('chat-header'),
            empty: document.getElementById('empty-state'),
            lock: document.getElementById('input-lock'),
            sessionCard: document.getElementById('active-session-card'),
            sessionName: document.getElementById('session-partner-name'),
            sessionId: document.getElementById('session-partner-id'),
            headerName: document.getElementById('header-name'),
            headerAvatar: document.getElementById('header-avatar')
        };

        // --- Initialization ---
        function init() {
            // Restore ID if saved, else random
            const savedId = localStorage.getItem('livelink_id');
            app.myId = savedId || Math.floor(100000 + Math.random() * 900000).toString();
            
            ui.customIdInput.value = app.myId;
            ui.customNameInput.value = app.myName;
            
            updateIdentityUI();
            initPeer(app.myId);
        }

        function initPeer(id) {
            if (app.peer) app.peer.destroy();
            
            app.peer = new Peer(id, {
                debug: 1,
                config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
            });

            app.peer.on('open', (id) => {
                app.myId = id; // Confirm ID (in case of conflict resolution, though PeerJS usually errors)
                updateIdentityUI();
                setStatus('online');
            });

            app.peer.on('connection', (conn) => {
                if (app.settings.dnd) {
                    conn.on('open', () => {
                        conn.send({ type: 'signal', action: 'decline', reason: 'DND' });
                        setTimeout(() => conn.close(), 500);
                    });
                    return;
                }

                if (app.conn) {
                    conn.on('open', () => {
                        conn.send({ type: 'signal', action: 'decline', reason: 'Busy' });
                        setTimeout(() => conn.close(), 500);
                    });
                    return;
                }

                // Handle incoming handshake
                conn.on('open', () => {
                   // Wait for data containing metadata
                });

                conn.on('data', (data) => {
                    if (data.type === 'signal' && data.action === 'handshake') {
                        // Received handshake
                        if (app.settings.autoAccept) {
                            acceptConnection(conn, data.name);
                        } else {
                            // Show request modal
                            app.pendingConn = conn;
                            app.pendingConn.metaName = data.name || 'Unknown';
                            ui.reqName.innerText = app.pendingConn.metaName;
                            ui.modals.request.classList.remove('hidden');
                            playSound('req');
                        }
                    } else if (app.conn && conn === app.conn) {
                         handleData(data);
                    }
                });
                
                conn.on('close', () => disconnect(false));
                conn.on('error', () => disconnect(false));
            });

            app.peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    showToast('ID taken. Reverting to random...', 'error');
                    localStorage.removeItem('livelink_id');
                    setTimeout(() => initPeer(Math.floor(100000 + Math.random() * 900000).toString()), 1000);
                } else {
                    showToast('Network Error. Retrying...', 'error');
                }
            });
        }

        // --- Identity Management ---
        function updateIdentityUI() {
            ui.idDisplay.innerText = app.myId;
            ui.navId.innerText = app.myId;
            ui.nameDisplay.innerText = app.myName;
        }

        function editIdentity() {
            ui.idView.classList.add('hidden');
            ui.idEdit.classList.remove('hidden');
        }

        function cancelEditIdentity() {
            ui.customIdInput.value = app.myId;
            ui.customNameInput.value = app.myName;
            ui.idEdit.classList.add('hidden');
            ui.idView.classList.remove('hidden');
        }

        function saveIdentity() {
            const newId = ui.customIdInput.value.trim().replace(/[^a-zA-Z0-9-_]/g, ''); // Sanitize
            const newName = ui.customNameInput.value.trim();

            if (!newId || !newName) return showToast('Invalid Input', 'error');

            app.myName = newName;
            localStorage.setItem('livelink_name', newName);

            if (newId !== app.myId) {
                // Changing ID requires reconnection
                disconnect(true, true); // Silent disconnect
                localStorage.setItem('livelink_id', newId);
                showToast('Updating ID...', 'info');
                initPeer(newId);
            }

            cancelEditIdentity();
            updateIdentityUI();
        }

        // --- Connection Logic ---
        function initiateConnection() {
            const target = ui.partnerInput.value.trim();
            if (!target || target === app.myId) return showToast('Invalid Target ID', 'error');

            ui.connectBtn.disabled = true;
            ui.connectBtn.innerHTML = 'Connecting...';

            const conn = app.peer.connect(target);
            
            conn.on('open', () => {
                // Send Handshake
                conn.send({ type: 'signal', action: 'handshake', name: app.myName });
                
                // Temporary state until Accepted
                ui.connectBtn.innerHTML = 'Waiting for Approval...';
            });

            conn.on('data', (data) => {
                if (data.type === 'signal') {
                    if (data.action === 'accept') {
                        setupActiveConnection(conn, data.name);
                    } else if (data.action === 'decline') {
                        showToast(`Request Declined: ${data.reason || 'No reason'}`, 'error');
                        conn.close();
                        resetConnectBtn();
                    }
                } else {
                    handleData(data);
                }
            });

            conn.on('close', () => {
                resetConnectBtn();
                if(app.conn) disconnect(false);
            });
            
            // Timeout if no response
            setTimeout(() => {
                if (!app.conn && ui.connectBtn.disabled) {
                    showToast('No response from user', 'error');
                    conn.close();
                    resetConnectBtn();
                }
            }, 10000);
        }

        function handleRequestDecision(accepted) {
            ui.modals.request.classList.add('hidden');
            const conn = app.pendingConn;
            
            if (accepted) {
                conn.send({ type: 'signal', action: 'accept', name: app.myName });
                acceptConnection(conn, conn.metaName);
            } else {
                conn.send({ type: 'signal', action: 'decline', reason: 'User declined' });
                setTimeout(() => conn.close(), 100);
                app.pendingConn = null;
            }
        }

        function acceptConnection(conn, partnerName) {
            app.pendingConn = null;
            setupActiveConnection(conn, partnerName);
        }

        function setupActiveConnection(conn, partnerName) {
            app.conn = conn;
            setStatus('connected');
            
            // Update UI
            ui.sessionName.innerText = partnerName;
            ui.sessionId.innerText = conn.peer;
            ui.headerName.innerText = partnerName;
            ui.headerAvatar.innerText = partnerName.substring(0,2).toUpperCase();
            
            // Show Cards / Unlock Input
            ui.sessionCard.classList.remove('hidden');
            ui.header.classList.remove('-translate-y-full');
            ui.lock.classList.add('hidden');
            ui.empty.classList.add('hidden');
            
            // Hide connection form
            ui.connectBtn.parentElement.parentElement.classList.add('hidden');
            
            showToast('Secure Connection Established', 'success');
            
            // Mobile: Close drawer
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function disconnect(local = true, silent = false) {
            if (app.conn) app.conn.close();
            app.conn = null;
            
            setStatus('online');
            
            // Reset UI
            ui.sessionCard.classList.add('hidden');
            ui.header.classList.add('-translate-y-full');
            ui.lock.classList.remove('hidden');
            ui.empty.classList.remove('hidden');
            ui.typing.style.opacity = '0';
            
            // Show connection form again
            ui.connectBtn.parentElement.parentElement.classList.remove('hidden');
            resetConnectBtn();

            if (!silent) showToast(local ? 'Disconnected' : 'Partner Disconnected', 'info');
        }

        function resetConnectBtn() {
            ui.connectBtn.disabled = false;
            ui.connectBtn.innerHTML = `<span>SEND REQUEST</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`;
        }

        // --- Messaging ---
        function sendMessage() {
            const text = ui.input.value.trim();
            if (!text || !app.conn) return;

            const msg = { type: 'chat', text: text, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
            app.conn.send(msg);
            appendMessage(msg, true);
            ui.input.value = '';
            ui.input.style.height = 'auto';
            ui.input.focus();
        }

        function handleData(data) {
            if (data.type === 'chat') {
                ui.typing.style.opacity = '0';
                appendMessage(data, false);
                playSound('msg');
            } else if (data.type === 'typing') {
                ui.typing.style.opacity = '1';
                clearTimeout(app.typingTimer);
                app.typingTimer = setTimeout(() => ui.typing.style.opacity = '0', 3000);
            }
        }

        function appendMessage(data, isMe) {
            const div = document.createElement('div');
            div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} animate-slide-up`;
            div.innerHTML = `
                <div class="max-w-[85%] lg:max-w-[70%] flex flex-col ${isMe ? 'items-end' : 'items-start'} gap-1">
                    <div class="${isMe ? 'bg-cyber-primary/10 border-cyber-primary/20 text-white' : 'bg-cyber-surface2 border-white/10 text-cyber-text'} border px-4 py-2 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} shadow-sm break-words">
                        <p class="text-sm leading-relaxed">${escapeHtml(data.text)}</p>
                    </div>
                    <span class="text-[10px] text-cyber-muted font-mono opacity-60">${data.time}</span>
                </div>`;
            ui.messages.appendChild(div);
            ui.messages.scrollTop = ui.messages.scrollHeight;
        }

        function handleTyping() {
            if(app.conn) app.conn.send({ type: 'typing' });
        }

        // --- Helpers ---
        function setStatus(s) {
            if (s === 'online') {
                ui.statusDot.className = 'absolute inset-0 rounded-full bg-cyber-warning shadow-[0_0_8px_rgba(255,179,2,0.5)] transition-colors duration-500';
                ui.statusPing.classList.add('hidden');
            } else {
                ui.statusDot.className = 'absolute inset-0 rounded-full bg-cyber-primary shadow-[0_0_8px_rgba(0,255,159,0.5)] transition-colors duration-500';
                ui.statusPing.classList.remove('hidden');
            }
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            icon.className = type === 'error' ? 'text-cyber-danger' : 'text-cyber-primary';
            t.classList.remove('-translate-y-32');
            setTimeout(() => t.classList.add('-translate-y-32'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSidebar() {
            const isClosed = ui.sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                ui.sidebar.classList.remove('-translate-x-full');
                ui.overlay.classList.remove('hidden');
                setTimeout(() => ui.overlay.classList.remove('opacity-0'), 10);
            } else {
                ui.sidebar.classList.add('-translate-x-full');
                ui.overlay.classList.add('opacity-0');
                setTimeout(() => ui.overlay.classList.add('hidden'), 300);
            }
        }

        function toggleSettings() {
            ui.modals.settings.classList.toggle('hidden');
        }

        function updateSettingsUI() {
            const toggle = (id, active) => {
                const btn = document.getElementById(id);
                const dot = btn.firstElementChild;
                if (active) {
                    btn.classList.replace('bg-gray-700', 'bg-cyber-primary');
                    dot.classList.add('translate-x-5');
                    dot.classList.replace('bg-white', 'bg-black');
                } else {
                    btn.classList.replace('bg-cyber-primary', 'bg-gray-700');
                    dot.classList.remove('translate-x-5');
                    dot.classList.replace('bg-black', 'bg-white');
                }
            };
            toggle('btn-sound', app.settings.sound);
            toggle('btn-dnd', app.settings.dnd);
            toggle('btn-auto', app.settings.autoAccept);
        }

        function copyId() {
            navigator.clipboard.writeText(app.myId).then(() => showToast('ID Copied', 'success'));
        }
        
        function clearChat() {
            ui.messages.innerHTML = '';
        }

        // Listeners
        ui.input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        
        window.onload = init;

    </script>
</body>
</html>
